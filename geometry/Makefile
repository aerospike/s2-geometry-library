# Please edit the following:
PYTHON_VER=2.6
SWIG_BINARY=swig
ZLIB_DIR=/usr

#  ----- No more editing below -----

PYTHON_INC=-I/usr/include/python$(PYTHON_VER) -I/usr/lib/python$(PYTHON_VER)

DEBUG=-g -O3 -DNDEBUG
# DEBUG=-O3 -DNDEBUG
SYSCFLAGS=-fPIC

ZLIB_INC = -I$(ZLIB_DIR)/include
CFLAGS= $(SYSCFLAGS) $(DEBUG) -I. -DARCH_K8 $(ZLIB_INC) \
        -Wno-deprecated -DS2_USE_EXACTFLOAT

CFLAGS += -DHASH_NAMESPACE=__gnu_cxx

# ----- OS Dependent -----
OS=$(shell uname -s)

ifeq ($(OS),Linux)
LD = gcc -shared
ZLIB_LNK = -Wl,-rpath $(ZLIB_DIR)/lib -L$(ZLIB_DIR)/lib -lz
endif
ifeq ($(OS),Darwin) # Assume Mac Os X
LD = ld -arch x86_64 -bundle -flat_namespace -undefined suppress
ZLIB_LNK = -L$(ZLIB_DIR)/lib -lz
endif

LDFLAGS=$(ZLIB_LNK)

# Real targets

BINARIES= #s2cellid_test

all: mkobjdir libs $(BINARIES)

LIBS = \
	libgoogle-base.a\
	libgoogle-strings.a\
	libgoogle-util-math.a\
	libgoogle-util-coding.a\
	libgoogle-util-geometry-s2cellid.a\
	libgoogle-util-geometry-s2.a\
	libgoogle-util-geometry-s2testing.a

mkobjdir:
	mkdir -p objs
	mkdir -p base/objs
	mkdir -p strings/objs
	mkdir -p util/math/objs
	mkdir -p util/coding/objs

libs: $(LIBS)

clean:
	rm -f *.a
	rm -f objs/*.o
	rm -f base/objs/*.o
	rm -f strings/objs/*.o
	rm -f util/math/objs/*.o
	rm -f util/coding/objs/*.o
	rm -f $(BINARIES)
	rm -f s2/*wrap*
	rm -f *.so

# base.

GOOGLE_BASE_LIB_OBJS = \
	base/objs/strtoint.o\
	base/objs/int128.o\
	base/objs/logging.o\
	base/objs/stringprintf.o

base/objs/int128.o:base/int128.cc
	$(CXX) $(CFLAGS) -c base/int128.cc -o base/objs/int128.o
base/objs/logging.o:base/logging.cc
	$(CXX) $(CFLAGS) -c base/logging.cc -o base/objs/logging.o
base/objs/stringprintf.o:base/stringprintf.cc
	$(CXX) $(CFLAGS) -c base/stringprintf.cc -o base/objs/stringprintf.o
base/objs/strtoint.o:base/strtoint.cc
	$(CXX) $(CFLAGS) -c base/strtoint.cc -o base/objs/strtoint.o

libgoogle-base.a: $(GOOGLE_BASE_LIB_OBJS)
	$(AR) rv libgoogle-base.a $(GOOGLE_BASE_LIB_OBJS)

# strings

GOOGLE_STRINGS_LIB_OBJS = \
	strings/objs/ascii_ctype.o\
	strings/objs/split.o\
	strings/objs/stringprintf.o\
	strings/objs/strutil.o

strings/objs/ascii_ctype.o:strings/ascii_ctype.cc
	$(CXX) $(CFLAGS) -c strings/ascii_ctype.cc -o strings/objs/ascii_ctype.o
strings/objs/split.o:strings/split.cc
	$(CXX) $(CFLAGS) -c strings/split.cc -o strings/objs/split.o
strings/objs/stringprintf.o:strings/stringprintf.cc
	$(CXX) $(CFLAGS) -c strings/stringprintf.cc -o strings/objs/stringprintf.o
strings/objs/strutil.o:strings/strutil.cc
	$(CXX) $(CFLAGS) -c strings/strutil.cc -o strings/objs/strutil.o

libgoogle-strings.a: $(GOOGLE_STRINGS_LIB_OBJS)
	$(AR) rv libgoogle-strings.a $(GOOGLE_STRINGS_LIB_OBJS)

# util/coding

GOOGLE_UTIL_CODING_LIB_OBJS = \
	util/coding/objs/coder.o\
	util/coding/objs/varint.o

util/coding/objs/coder.o:util/coding/coder.cc
	$(CXX) $(CFLAGS) -c util/coding/coder.cc -o util/coding/objs/coder.o
util/coding/objs/varint.o:util/coding/varint.cc
	$(CXX) $(CFLAGS) -c util/coding/varint.cc -o util/coding/objs/varint.o

libgoogle-util-coding.a: $(GOOGLE_UTIL_CODING_LIB_OBJS)
	$(AR) rv libgoogle-util-coding.a $(GOOGLE_UTIL_CODING_LIB_OBJS)

# util/math

GOOGLE_UTIL_MATH_LIB_OBJS = \
	util/math/objs/mathutil.o\
	util/math/objs/mathlimits.o\
	util/math/objs/exactfloat.o

util/math/objs/mathutil.o:util/math/mathutil.cc
	$(CXX) $(CFLAGS) -c util/math/mathutil.cc -o util/math/objs/mathutil.o
util/math/objs/mathlimits.o:util/math/mathlimits.cc
	$(CXX) $(CFLAGS) -c util/math/mathlimits.cc -o util/math/objs/mathlimits.o
util/math/objs/exactfloat.o:util/math/exactfloat/exactfloat.cc
	$(CXX) $(CFLAGS) -c util/math/exactfloat/exactfloat.cc -o util/math/objs/exactfloat.o
#util/math/objs/exactfloat_test.o:util/math/exactfloat/exactfloat_test.cc
#	$(CXX) $(CFLAGS) -c util/math/exactfloat/exactfloat_test.cc -o util/math/objs/exactfloat_test.o
#util/math/objs/vector_unittest.o:util/math/vector_unittest.cc
#	$(CXX) $(CFLAGS) -c util/math/vector_unittest.cc -o util/math/objs/vector_unittest.o

libgoogle-util-math.a: $(GOOGLE_UTIL_MATH_LIB_OBJS)
	$(AR) rv libgoogle-util-math.a $(GOOGLE_UTIL_MATH_LIB_OBJS)
#exactfloat_test: $(LIBS) objs/exactfloat_test.o
#	$(CXX) $(CFLAGS) $(LDFLAGS) objs/exactfloat_test.o $(LIBS) -o exactfloat_test
#vector_unittest: $(LIBS) objs/vector_unittest.o
#	$(CXX) $(CFLAGS) $(LDFLAGS) objs/vector_unittest.o $(LIBS) -o vector_unittest

# util/geometry

GOOGLE_UTIL_GEOMETRY_S2CELLID_LIB_OBJS = \
	objs/s1angle.o\
	objs/s2.o\
	objs/s2cellid.o\
	objs/s2latlng.o

GOOGLE_UTIL_GEOMETRY_S2_LIB_OBJS = \
	objs/s1interval.o\
	objs/s2cap.o\
	objs/s2cell.o\
	objs/s2cellunion.o\
	objs/s2edgeindex.o\
	objs/s2edgeutil.o\
	objs/s2latlngrect.o\
	objs/s2loop.o\
	objs/s2pointregion.o\
	objs/s2polygon.o\
	objs/s2polygonbuilder.o\
	objs/s2polyline.o\
	objs/s2r2rect.o\
	objs/s2region.o\
	objs/s2regioncoverer.o\
	objs/s2regionintersection.o\
	objs/s2regionunion.o

GOOGLE_UTIL_GEOMETRY_S2TESTING_LIB_OBJS = \
	objs/s2testing.o

objs/s1angle.o:s1angle.cc
	$(CXX) $(CFLAGS) -c s1angle.cc -o objs/s1angle.o
objs/s1interval.o:s1interval.cc
	$(CXX) $(CFLAGS) -c s1interval.cc -o objs/s1interval.o
objs/s2.o:s2.cc
	$(CXX) $(CFLAGS) -c s2.cc -o objs/s2.o
objs/s2cap.o:s2cap.cc
	$(CXX) $(CFLAGS) -c s2cap.cc -o objs/s2cap.o
objs/s2cell.o:s2cell.cc
	$(CXX) $(CFLAGS) -c s2cell.cc -o objs/s2cell.o
objs/s2cellid.o:s2cellid.cc
	$(CXX) $(CFLAGS) -c s2cellid.cc -o objs/s2cellid.o
objs/s2cellunion.o:s2cellunion.cc
	$(CXX) $(CFLAGS) -c s2cellunion.cc -o objs/s2cellunion.o
objs/s2edgeindex.o:s2edgeindex.cc
	$(CXX) $(CFLAGS) -c s2edgeindex.cc -o objs/s2edgeindex.o
objs/s2edgeutil.o:s2edgeutil.cc
	$(CXX) $(CFLAGS) -c s2edgeutil.cc -o objs/s2edgeutil.o
objs/s2latlng.o:s2latlng.cc
	$(CXX) $(CFLAGS) -c s2latlng.cc -o objs/s2latlng.o
objs/s2latlngrect.o:s2latlngrect.cc
	$(CXX) $(CFLAGS) -c s2latlngrect.cc -o objs/s2latlngrect.o
objs/s2loop.o:s2loop.cc
	$(CXX) $(CFLAGS) -c s2loop.cc -o objs/s2loop.o
objs/s2pointregion.o:s2pointregion.cc
	$(CXX) $(CFLAGS) -c s2pointregion.cc -o objs/s2pointregion.o
objs/s2polygon.o:s2polygon.cc
	$(CXX) $(CFLAGS) -c s2polygon.cc -o objs/s2polygon.o
objs/s2polygonbuilder.o:s2polygonbuilder.cc
	$(CXX) $(CFLAGS) -c s2polygonbuilder.cc -o objs/s2polygonbuilder.o
objs/s2polyline.o:s2polyline.cc
	$(CXX) $(CFLAGS) -c s2polyline.cc -o objs/s2polyline.o
objs/s2r2rect.o:s2r2rect.cc
	$(CXX) $(CFLAGS) -c s2r2rect.cc -o objs/s2r2rect.o
objs/s2region.o:s2region.cc
	$(CXX) $(CFLAGS) -c s2region.cc -o objs/s2region.o
objs/s2regioncoverer.o:s2regioncoverer.cc
	$(CXX) $(CFLAGS) -c s2regioncoverer.cc -o objs/s2regioncoverer.o
objs/s2regionintersection.o:s2regionintersection.cc
	$(CXX) $(CFLAGS) -c s2regionintersection.cc -o objs/s2regionintersection.o
objs/s2regionunion.o:s2regionunion.cc
	$(CXX) $(CFLAGS) -c s2regionunion.cc -o objs/s2regionunion.o
objs/s2testing.o:s2testing.cc
	$(CXX) $(CFLAGS) -c s2testing.cc -o objs/s2testing.o

libgoogle-util-geometry-s2cellid.a: $(GOOGLE_UTIL_GEOMETRY_S2CELLID_LIB_OBJS)
	$(AR) rv libs2cellid.a $(GOOGLE_UTIL_GEOMETRY_S2CELLID_LIB_OBJS)

libgoogle-util-geometry-s2.a: $(GOOGLE_UTIL_GEOMETRY_S2_LIB_OBJS)
	$(AR) rv libs2.a $(GOOGLE_UTIL_GEOMETRY_S2_LIB_OBJS)

libgoogle-util-geometry-s2testing.a: $(GOOGLE_UTIL_GEOMETRY_S2TESTING_LIB_OBJS)
	$(AR) rv libs2testing.a $(GOOGLE_UTIL_GEOMETRY_S2TESTING_LIB_OBJS)
